# NC Pilot Multi‑Pair — риск‑контроль и guard‑логика (RU)

## 1. Принципы безопасности

1. **Риск должен быть локализован**: проблема в одной паре не должна распространяться.
2. **Блокировка важнее доходности**: при сомнениях — стоп и пауза.
3. **Прозрачные причины**: каждое блокирование пишет точную причину.

## 2. Уровни защиты

### 2.1 Global guards (весь режим)

- **Kill‑switch** по общей просадке (DD).
- **Max open orders** — ограничение суммарного числа ордеров.
- **Latency guard** — отключение при превышении задержек.
- **Data integrity** — блокировка при неполных/битых данных.

### 2.2 Cluster guards

- **Max cluster exposure**.
- **Max correlation** между pairs.
- **Cluster volatility spike**.
- **Liquidity drop** (depth/volume).

### 2.3 Pair guards

- **Thin edge guard** — недостаточная маржа.
- **Break‑even guard** — блок при цене ниже breakeven.
- **Spread guard** — спред шире допустимого.
- **Stale guard** — цена устарела.

## 3. Типовые гейты (пример матрицы)

| Guard | Условие | Действие |
| --- | --- | --- |
| `stale_price` | now - last_tick > TTL | pause pair, cancel orders |
| `vol_spike` | vol > vol_limit | reduce grid count |
| `thin_edge` | edge_bps < min_edge | reject intent |
| `drawdown` | pnl_pct < -DD | kill‑switch |

## 4. Kill‑switch сценарии

1. **Экстренный стоп**: при DD > порога отменить все ордера и заморозить.
2. **Деградация**: если DD растёт, сократить активные пары.
3. **Ручной стоп**: оператор переводит режим в `PAUSED`.

## 5. Защита от каскадного риска

- **Isolation**: ошибки одной пары не влияют на другие.
- **Budget cap**: лимит бюджета на pair.
- **Hedge ratio guard**: запрет на одностороннюю экспозицию.

## 6. Контроль волатильности

- Измерение волатильности на окнах (1m, 5m, 15m).
- При spike:
  - увеличить шаг сетки,
  - уменьшить количество уровней,
  - включить cooldown.

## 7. Контроль спреда

- Использовать `spread_bps` из orderbook.
- Запрет операций, если `spread_bps` > лимита.
- При повторяющемся превышении — исключить пару из кластера.

## 8. Контроль ликвидности

- Минимальная глубина стакана в 1% от mid‑price.
- Минимальный суточный объём.
- При падении ликвидности — переключение пары в `COOLDOWN`.

## 9. Ребаланс‑контроль

- Ребаланс разрешён только при `guard_status = OK`.
- При частичном выполнении включается rollback.
- Если обе legs не подтверждены в заданном окне — stop.

## 10. Логи и аудит

- Каждое guard‑решение пишет `guard_id`, `reason`, `threshold`, `actual`.
- Запись в журнал кластера и пары.

## 11. Пример политики порогов

- `max_pairs_active = 6`
- `max_cluster_exposure = 25%`
- `max_drawdown_pct = 5%`
- `max_spread_bps = 8`
- `min_edge_bps = 3`

## 12. Чек‑лист оператора

- Kill‑switch не активирован?
- Нет превышений `max_spread_bps`?
- Есть ли пары с `stale_price`?
- Поддерживается ли hedge ratio по кластеру?

## 13. Дополнительные требования к логам и аудиту

### 13.1 Какие логи обязательны

- `GUARD_REJECT` с точной причиной.
- `KILL_SWITCH` с параметрами и текущим PnL.
- `REBALANCE_ROLLBACK` с указанием leg и размера.
- `DATA_STALE` с возрастом данных и источником.

### 13.2 Аудит и трассировка

- Каждая команда `Intent` должна иметь `trace_id`.
- Связь `trace_id` хранится в State Store и логах ордеров.
- Минимальный набор полей: `cluster_id`, `pair_id`, `action`, `guard_status`.

## 14. Чеклист тестирования guard‑логики

1. Симулировать stale‑данные и проверить блокировку действий.
2. Смоделировать spread spike и проверить переход в `PAUSED`.
3. Превысить max drawdown и убедиться, что kill‑switch отменяет все ордера.
4. Имитировать частичное исполнение leg и проверить rollback.

## 15. Настройка лимитов (рекомендации)

- Ставить `max_correlation` ниже 0.8 для волатильных пар.
- Лимит `max_open_orders` подбирать так, чтобы cancel‑масштаб был ≤ 2 секунды.
- `min_liquidity_score` повышать для мало‑ликвидных альтов.
