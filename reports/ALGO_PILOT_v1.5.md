# ALGO PILOT v1.5 (фактическая версия в коде: v1.6.5) — подробное описание режима

> Документ описывает текущую реализацию режима **Lite All Strategy — ALGO PILOT** и его поведение в UI. Основан на коде `src/gui/lite_all_strategy_algo_pilot_window.py`.

## 1. Назначение режима

**ALGO PILOT** — расширение режима Lite All Strategy, добавляющее полуаавтоматические (и опционально авто‑) действия поверх grid‑логики: перестроение сетки, безубыток, обработка устаревших ордеров, KPI‑проверки рынка и безопасное выполнение действий в live‑среде.

Режим предназначен для:

- быстрого контроля сетки, риска и рыночных условий;
- ускорения ручных действий (recenter/recovery/flatten);
- контроля перехода между dry‑run и live;
- формализации минимальной прибыльности (profit‑guard) и блокировки действий при сомнительной ликвидности (KPI‑guard);
- диагностики устаревших ордеров по дрейфу и выходу за диапазон.

## 2. Где находится и как открыть

1. В Overview выбирается торговая пара.
2. Открывается `PairActionDialog`, где доступен пункт **Lite All Strategy — ALGO PILOT**.
3. `PairModeManager` создаёт окно `LiteAllStrategyAlgoPilotWindow`.

ALGO PILOT — отдельное окно/режим (не плагин и не вкладка внутри MainWindow).

## 3. Архитектура окна и окружение

Главный класс: `LiteAllStrategyAlgoPilotWindow(QMainWindow)`.

### 3.1 Основные внутренние компоненты

- **GridEngine** — построение планов сетки (планируемые ордера по BUY/SELL).
- **PriceFeedManager** — лайв‑цены + статусы WS/HTTP.
- **BinanceHttpClient / BinanceAccountClient** — правила символа, балансы, ордера.
- **DataCache** — локальный кэш HTTP‑ответов.
- **FillAccumulator / локальный реестр ордеров** — сбор fills, дедупликация и контроль «дублирующих» ордеров.

### 3.2 Таймеры и циклы обновления

- Балансы: каждые 10 сек.
- Ордера: каждые 3 сек.
- Fills: каждые ~2.5 сек.
- Панель ALGO PILOT: каждые 0.75 сек.
- KPI‑панель рынка (спред/волатильность/источник): каждые 0.5 сек.
- GC реестра ордеров: каждые 60 сек (TTL 10 минут).

## 4. Layout UI (блоки интерфейса)

### 4.1 Header

- Символ и последняя цена.
- Кнопки **Start / Pause / Stop**.
- Переключатель **Dry‑Run**.
- Бейдж состояния (state/engine).
- Статусы источников (HTTP/WS), age/latency, торговый статус.

### 4.2 Market panel (KPI)

- Метрики: цена, спред, волатильность, комиссия, источник данных.
- Строка правил символа (tick/step/minNotional).
- KPI‑логика анализирует:
  - наличие bid/ask,
  - спред (включая список исключений, где допускается нулевой спред),
  - волатильность (с окнами/TTL и debounce).

### 4.3 ALGO PILOT panel (внутри Market panel)

**Метрики:**
- Состояние пилота (OFF/NORMAL/RECENTERING/RECOVERY/PAUSED_BY_RISK).
- Режим рынка (диапазон/режим фазы).
- Якорь, отклонение от якоря, порог.
- Позиция, средняя цена входа, безубыток, нереализованный PnL.
- Открытые ордера (total/buy/sell), самый старый, порог устаревания, число устаревших.
- Блок предупреждений (stale, snapshot stale, KPI/guard предупреждения).

**Кнопки действий:**
- **Пилот ВКЛ/ВЫКЛ** — включает/выключает логику (без торговли при OFF).
- **Перестроить сетку** — recenter от якоря, отмена старых ордеров.
- **В режим безубытка** — recovery: постановка лимит‑ордера на BE.
- **Закрыть в безубыток** — flatten: закрытие позиции по BE.
- **Пометить устаревшие** — ручная проверка stale‑ордеров.

**Переключатели и политики:**
- Авто‑действия пилота (по триггерам; UI может быть заблокирован в текущей сборке).
- Политика устаревших ордеров: `NONE`, `RECENTER`, `CANCEL_REPLACE_STALE`.
- «Всегда спрашивать (DRY)» — в текущей реализации игнорируется и всегда сбрасывается.
- «Разрешить MARKET (закрытие)» — опция для закрытия, но фактически остаётся лимитный fallback.

### 4.4 Grid Settings panel

- Бюджет, направление (Neutral/Long‑biased/Short‑biased).
- Количество уровней.
- Шаг сетки (AUTO_ATR / MANUAL) + manual override.
- Диапазоны (Auto/Manual, low/high).
- Take‑profit + кнопка Fix TP.
- Stop‑loss toggle + значение.
- Максимум активных ордеров.
- Режим размера ордера (Equal/ByQuote и др. — зависит от реализации расчёта).

### 4.5 Runtime panel

- Статус аккаунта.
- Балансы (quote/base + bot‑балансы).
- PnL и статистика ордеров.
- Таблица открытых ордеров + контекстное меню.
- Кнопки: Cancel selected / Cancel all / Refresh.
- Toggle «Cancel all on stop».

### 4.6 Logs panel

- Фильтры логов (all/orders/errors).
- Clear / Copy all / Collapse.
- Summary по сделкам (closed/win/avg/fees).

## 5. Основные сущности и структуры данных

### 5.1 GridSettingsState

Снимок параметров сетки: бюджет, направление, шаг, режимы, диапазоны, TP/SL, лимит ордеров, режим размера.

### 5.2 PilotState

- `OFF` — пилот выключен.
- `NORMAL` — пилот включён и работает в стандартном режиме.
- `RECENTERING` — в процессе перестроения.
- `RECOVERY` — защитный режим (exit в BE).
- `PAUSED_BY_RISK` — блокировка логики из‑за риска.

### 5.3 PilotAction

- `TOGGLE`, `RECENTER`, `RECOVERY`, `FLATTEN_BE`, `FLAG_STALE`, `CANCEL_REPLACE_STALE`.

### 5.4 TradeGate

Контроль возможности live‑торговли:
- `TRADE_OK`
- `TRADE_DISABLED_NO_KEYS`
- `TRADE_DISABLED_API_ERROR`
- `TRADE_DISABLED_CANT_TRADE`
- `TRADE_DISABLED_SYMBOL`
- `TRADE_DISABLED_READONLY`
- `TRADE_DISABLED_NO_CONFIRM`

### 5.5 StalePolicy

- `NONE` — только предупреждать.
- `RECENTER` — перестроить сетку.
- `CANCEL_REPLACE_STALE` — отменить и заменить устаревшие.

### 5.6 Важные константы (выдержка)

- Recenter: `RECENTER_THRESHOLD_PCT = 0.7%`.
- Stale‑детектор:
  - базовый дрейф `STALE_DRIFT_PCT_DEFAULT = 0.20%`,
  - стабильный рынок `STALE_DRIFT_PCT_STABLE = 0.05%`,
  - буфер диапазона `STALE_BUFFER_MIN_PCT = 0.10%`.
- Stale‑тайминги:
  - warmup: `STALE_WARMUP_SEC = 30`,
  - cooldown: `STALE_COOLDOWN_SEC = 120`,
  - авто‑пауза: `STALE_AUTO_ACTION_PAUSE_SEC = 300`,
  - snapshot max age: `STALE_SNAPSHOT_MAX_AGE_SEC = 5`.
- Profit guard:
  - default maker/taker `0.10%`,
  - slippage `1.5 bps`,
  - buffer `0.03%`,
  - min floor `0.10%`,
  - thin spread factor `0.25`,
  - low vol factor `0.5`.
- KPI:
  - sampling window: `60s`,
  - min samples: `10`,
  - debounce: `5s`,
  - book request interval: `1000ms`.

## 6. Алгоритмы и ключевые сценарии

### 6.1 Построение сетки (GridEngine)

1. Проверка входных параметров (budget, grid_count, step, диапазоны).
2. Разделение уровней между BUY/SELL по направлению.
3. Разделение бюджета на buy/sell.
4. Построение цен по шагу % (step_pct) вокруг якоря.
5. Квантование по tick/step, проверка min_notional/min_qty/max_qty.
6. Если шаг слишком мал — fallback на tick ladder.

### 6.2 Profit guard

Profit guard поднимает TP/step/range до минимально прибыльного уровня с учётом:

- maker/taker комиссий (при отсутствии данных — дефолты),
- спреда и slippage,
- волатильности,
- буфера безопасности.

Если рынок слишком «тонкий» (spread/volatility ниже порогов), guard может поставить HOLD и блокировать старт/перестроение.

### 6.3 KPI‑guard (валидация рынка)

- KPI вычисляется из bid/ask и волатильности.
- Состояния: `OK`, `UNKNOWN`, `INVALID`.
- При `INVALID` блокируются действия **RECENTER** и **RECOVERY**.
- Есть debounce для кратких просадок KPI.

### 6.4 Перестроение (RECENTER)

1. Выбор якоря (текущая цена или ранее выбранный anchor).
2. Построение плана сетки + profit guard.
3. Break‑even guard — запрет SELL ниже BE или BUY выше BE.
4. Подтверждение действия (в LIVE — всегда, в DRY — по настройке).
5. Отмена текущих ордеров.
6. Размещение плана сетки (либо dry‑run визуализация).

### 6.5 Recovery / Flatten BE

- Recovery: цель — выставить лимит‑ордер на безубыток для всей позиции.
- Flatten BE: закрытие позиции в 0 (лимит, MARKET опционален, но пока fallback‑ится в лимитный ордер).
- Оба сценария отменяют текущие ордера, затем ставят один ордер по BE.

### 6.6 Устаревшие ордера (stale)

- Проверка по дрейфу цены относительно mid и по выходу за пределы диапазона.
- В учёт берётся «прогрев» (warmup) после действий, чтобы избежать флаппинга.
- Срабатывания дедуплицируются по времени и ID ордера.
- Устаревшие ордера могут триггерить авто‑действия (policy‑based), но с cooldown и паузами.

### 6.7 Авто‑действия пилота

Если включены:

- пилот инициирует `RECENTER` или `CANCEL_REPLACE_STALE` по триггерам;
- соблюдается cooldown (включая auto‑pause и действие‑debounce);
- при LIVE всё равно требуется подтверждение действия.

## 7. Safety и подтверждения

- В LIVE‑режиме все действия требуют `TradeGate == TRADE_OK` и подтверждения.
- `TradeGate` проверяет ключи, canTrade, торговые права, read‑only и факт подтверждения.
- В DRY‑режиме подтверждение для пилота сейчас жёстко выключено (переключатель сбрасывается).

## 8. Логи и наблюдаемость

- Каждое действие пилота фиксируется в логах (`[ALGO PILOT] ...`).
- KPI‑изменения пишутся отдельными сообщениями (`[KPI] state=...`), чтобы отследить причину блокировки.
- Отдельные предупреждения при stale‑состояниях, snapshot‑просрочке, profit‑guard блокировках.

## 9. Ограничения (из текущей реализации)

- MARKET‑закрытие формально разрешено тумблером, но фактически используется лимитный ордер.
- Profit guard может блокировать старт/перестроение при низкой ликвидности/волатильности.
- KPI‑guard может временно блокировать RECENTER/RECOVERY при отсутствии bid/ask или «нулевой» волатильности.
- Некоторые действия доступны только при валидных ключах Binance и подтверждениях.

---

Если нужно добавить разделы (например, детальный список сигналов/слотов, протоколы ошибок или сценарии тестирования), можно расширить документ точечно.
