# ALGO PILOT v1.5 — Полное описание режима

> Документ описывает текущую реализацию режима **Lite All Strategy — ALGO PILOT** и его поведение в UI. Основан на коде `src/gui/lite_all_strategy_algo_pilot_window.py`.

## 1. Назначение режима

**ALGO PILOT** — это расширение режима Lite All Strategy, которое добавляет полуавтоматические (и опционально авто‑) действия поверх grid‑логики: перестроение сетки, выход в безубыток, обработка устаревших ордеров, метрики состояния позиции и рынка. Режим предназначен для:

- быстрого контроля состояния сетки и риска;
- ускорения ручных действий (recenter/recovery/flatten);
- аккуратного перехода между dry‑run и live;
- формализации правил прибыльности через profit‑guard.

## 2. Где находится и как открыть

1. В Overview выбирается торговая пара.
2. Открывается `PairActionDialog`, где доступен пункт **Lite All Strategy — ALGO PILOT**.
3. `PairModeManager` создаёт окно `LiteAllStrategyAlgoPilotWindow`.

Таким образом ALGO PILOT — отдельное окно/режим, а не отдельный «плагин» или таб.

## 3. Архитектура окна

Главный класс: `LiteAllStrategyAlgoPilotWindow(QMainWindow)`.

### 3.1 Основные внутренние компоненты

- **GridEngine** — построение планов сетки (планируемые ордера по BUY/SELL).
- **PriceFeedManager** — лайв‑цены + статусы WS/HTTP.
- **BinanceHttpClient / BinanceAccountClient** — правила символа, балансы, ордера.
- **DataCache** — локальный кэш HTTP‑ответов.
- **FillAccumulator / локальный реестр ордеров** — сбор fills и контроль «дублирующих» ордеров.

### 3.2 Таймеры и циклы обновления

- Балансы: каждые 10 сек.
- Ордера: каждые 3 сек.
- Fills: каждые ~2.5 сек.
- Пилот‑панель: каждые 0.75 сек.
- KPI‑панель рынка: каждые 0.5 сек.

## 4. Layout UI (блоки интерфейса)

### 4.1 Header

- Символ и последняя цена.
- Кнопки **Start / Pause / Stop**.
- Переключатель **Dry‑Run**.
- Бейдж состояния (state/engine).
- Статусы источников (HTTP/WS), age/latency, торговый статус.

### 4.2 Market panel

- Метрики: цена, спред, волатильность, комиссия, источник данных.
- Отдельная строка с правилами символа (tick/step/minNotional).

### 4.3 ALGO PILOT panel (в Market panel)

**Метрики:**
- Состояние пилота (OFF/NORMAL/RECENTERING/RECOVERY/PAUSED_BY_RISK).
- Режим рынка (диапазон/режим фазы).
- Якорь, отклонение от якоря, порог.
- Позиция, средняя цена входа, безубыток, нереализованный PnL.
- Открытые ордера (total/buy/sell), самый старый, порог устаревания.
- Блок предупреждений (stale, snapshot stale, warning).

**Кнопки действий:**
- **Пилот ВКЛ/ВЫКЛ**
- **Перестроить сетку**
- **В режим безубытка**
- **Закрыть в безубыток**
- **Пометить устаревшие**

**Переключатели:**
- Авто‑действия пилота.
- Политика устаревших ордеров (`NONE`, `RECENTER`, `CANCEL_REPLACE`).
- Всегда спрашивать подтверждение в DRY.
- Разрешить MARKET (только для закрытия; фактически остаётся лимитный fallback).

### 4.4 Grid Settings panel

Параметры сетки:
- Бюджет, направление (Neutral/Long‑biased/Short‑biased).
- Количество уровней.
- Шаг сетки (AUTO_ATR или MANUAL).
- Диапазоны (Auto/Manual, low/high).
- Take‑profit + кнопка Fix TP.
- Stop‑loss toggle + значение.
- Максимум активных ордеров.
- Режим размера ордера.

### 4.5 Runtime panel

- Статус аккаунта.
- Балансы (quote/base + bot‑балансы).
- PnL и статистика ордеров.
- Таблица открытых ордеров + контекстное меню.
- Кнопки: Cancel selected / Cancel all / Refresh.
- Toggle «Cancel all on stop».

### 4.6 Logs panel

- Фильтры логов (all/orders/errors).
- Clear / Copy all / Collapse.
- Summary по сделкам (closed/win/avg/fees).

## 5. Основные сущности и структуры данных

### 5.1 GridSettingsState

Снимок параметров сетки: бюджет, направление, шаг, режимы, диапазоны, TP/SL, лимит ордеров.

### 5.2 PilotState

- `OFF` — пилот выключен.
- `NORMAL` — пилот включён и работает в стандартном режиме.
- `RECENTERING` — в процессе перестроения.
- `RECOVERY` — защитный режим (exit в BE).
- `PAUSED_BY_RISK` — блокировка логики из‑за риска.

### 5.3 TradeGate

Контроль возможности live‑торговли:
- `TRADE_OK`
- `TRADE_DISABLED_NO_KEYS`
- `TRADE_DISABLED_API_ERROR`
- `TRADE_DISABLED_CANT_TRADE`
- `TRADE_DISABLED_SYMBOL`
- `TRADE_DISABLED_READONLY`
- `TRADE_DISABLED_NO_CONFIRM`

### 5.4 StalePolicy

- `NONE` — только предупреждать.
- `RECENTER` — перестроить сетку.
- `CANCEL_REPLACE_STALE` — отменить и заменить устаревшие.

### 5.5 Важные константы

- Порог recenter: `RECENTER_THRESHOLD_PCT = 0.7%`.
- Порог устаревания ордеров: `MAX_ORDER_AGE_SEC = 180`.
- Максимальный возраст снапшота: `STALE_SNAPSHOT_MAX_AGE_SEC = 5`.
- Cooldown авто‑действий: `STALE_AUTO_ACTION_COOLDOWN_SEC = 300`.
- Profit guard: набор дефолтов по комиссиям/буферу/спреду.

## 6. Алгоритмы и ключевые сценарии

### 6.1 Построение сетки (GridEngine)

1. Проверка входных параметров (budget, grid_count, step, диапазоны).
2. Разделение уровней между BUY/SELL по направлению.
3. Разделение бюджета на buy/sell.
4. Построение цен по шагу % (step_pct) вокруг якоря.
5. Квантование по tick/step, проверка min_notional/min_qty/max_qty.
6. Если шаг слишком мал — fallback на tick ladder.

### 6.2 Profit guard

Profit guard поднимает TP/step/range до минимально прибыльного уровня с учётом:

- maker/taker комиссий (если нет данных — используются дефолты),
- спреда,
- волатильности,
- буфера безопасности.

Если рынок слишком «тонкий» (spread/volatility ниже порогов), guard может поставить HOLD и блокировать запуск/перестроение.

### 6.3 Перестроение (RECENTER)

1. Выбор якоря (текущая цена или ранее выбранный anchor).
2. Построение плана сетки + profit guard.
3. Break‑even guard — запрет SELL ниже BE или BUY выше BE.
4. Подтверждение действия (в LIVE — всегда, в DRY — по настройке).
5. Отмена текущих ордеров.
6. Размещение плана сетки (либо dry‑run визуализация).

### 6.4 Recovery / Flatten BE

- Recovery: цель — выставить лимит‑ордер на безубыток для всей позиции.
- Flatten BE: похожий сценарий, но более «жёсткий» (закрытие позиции в 0).
- Оба сценария отменяют текущие ордера, затем ставят один лимитный ордер по BE.

### 6.5 Устаревшие ордера

- Считаются по возрасту последнего обновления.
- При превышении порога пилот показывает предупреждение и предлагает действие.
- В авто‑режиме запускается выбранная `StalePolicy`.

### 6.6 Авто‑действия пилота

Если включены:

- пилот сам инициирует `RECENTER` или `CANCEL_REPLACE_STALE` по триггерам;
- соблюдается cooldown, чтобы избежать флаппинга;
- при LIVE всё равно требуется подтверждение действия.

## 7. Safety и подтверждения

- В LIVE‑режиме все действия требуют `TradeGate == TRADE_OK` и подтверждения.
- `TradeGate` проверяет ключи, статус аккаунта, canTrade, торговые права.
- В DRY‑режиме подтверждение зависит от тумблера «Всегда спрашивать».

## 8. Логи и наблюдаемость

- Каждое действие пилота фиксируется в логах (`[ALGO PILOT] ...`).
- Отдельные предупреждения при stale‑состояниях, snapshot‑просрочке, profit‑guard блокировках.

## 9. Ограничения (из текущей реализации)

- MARKET‑закрытие формально разрешено тумблером, но фактически используется лимитный ордер.
- Profit guard может блокировать старт/перестроение при низкой ликвидности/волатильности.
- Некоторые действия доступны только при валидных ключах Binance и подтверждениях.

---

Если нужно добавить разделы (например, детальный список сигналов/слотов, протоколы ошибок или сценарии тестирования), уточните — документ можно расширить точечно.
